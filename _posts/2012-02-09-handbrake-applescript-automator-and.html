---
layout: post
title: "Handbrake, Applescript, Automator, and iTunes Together as a Folder Action"
date: 2012-02-09
comments: false
categories:
 - m4v
 - handbrake
 - avi
 - applescript
 - itunes
 - automator
 - apple
---

<div class='post'>
Yesterday I posted about my initial attempt at automatically converting .avi files with handbrake to m4v files and having them automatically added to iTunes. &nbsp;That plan worked fine if the items dropped into my watched folder were all of the type .avi AND they weren't in a subdirectory.<br /><br />Tonight I decided to try and address these two deficincies. &nbsp;First I can now handle the case where a folder is the "input" parameter; though my knowledge of applescript is so deficient I can only deal with one layer of directory heirarchy - sorry, no recursion. &nbsp;I also now test for the extension of the file being processed to make sure it is an .avi before proceeding (otherwise I just skip the file).<br /><br />Yesterday I also made the script look a little more generic by hiding some of the elements of my directory structure by using words like "me" - today I decided to just post it as I wrote it. &nbsp;You will have to change some variable values to make this work on your system.<br /><br /><br /><pre class="sql" name="code">on run {input, parameters}<br /> repeat with x in input<br /><br />  -- need to determine if input is a file or a directory..<br />  set details to (info for x without size)<br />  set allFiles to {}<br /><br />  if kind of details is "folder" then<br />   -- if it is a folder, we need to grab all the contents as a list<br />   set tempFiles to list folder (x) without invisibles<br />   repeat with y in tempFiles<br />    set the end of allFiles to ((x as string) &amp; y) as alias<br />   end repeat<br />  else<br />   -- if it is a file then we make a one item list..<br />   set the end of allFiles to x as alias<br />  end if<br />  <br />  -- now loop over the list we just made.<br />  repeat with i in allFiles<br />   <br />   -- only process avi files.<br />   if name extension of (info for i) is "avi" then<br />    try<br />     set text item delimiters to ":"<br />     set file_name to last text item of (i as text)<br />     set text item delimiters to ""<br />    on error<br />     set text item delimiters to ""<br />    end try<br />    <br />    set origFilepath to quoted form of POSIX path of (i as alias)<br />    set newFileName to "" &amp; (characters 1 thru -5 of file_name as string) &amp; ".m4v"<br />    set newFilepath to "/Users/bill/temp_movies/mp4/" &amp; newFileName &amp; ""<br />    <br />    <br />    --apple uses colons as delimiters while the  Untitled=drive; Users=directory; me=username; mp4=temp directory..<br />    set finalPath to ("Untitled:Users:bill:temp_movies:mp4:" &amp; newFileName)<br />    <br />    <br />    --start the conversion; shell command uses the forward slash as the delimiter; hence two finalpath defined.<br />    set shellCommand to "nice /Applications/HandBrakeCLI -i " &amp; origFilepath &amp; " -o " &amp; newFilepath &amp; " --preset=\"AppleTV 2\";"<br />    do shell script shellCommand<br />    <br />    --I've told itunes to copy files on import; this way I don't have m4v's laying all over the place<br />    tell application "iTunes"<br />     add finalPath<br />    end tell<br />    <br />    --after the import is done I delete the m4v file I just created (from the temp directory)<br />    tell application "Finder"<br />     delete finalPath<br />    end tell<br />    <br />    -- prepare the movie for later deletion..<br />    set trashPath to "Untitled:Users:bill:temp_movies:to_trash:"<br />    tell application "Finder"<br />     move i to folder trashPath<br />    end tell<br />   end if<br />  end repeat<br /> end repeat<br /> return input<br />end run<br /></pre></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
Dear Mr. Rawlinson!<br /><br />How would a script look like, that converts all *.mov from my &quot;movies/mov&quot; folder to &quot;automatically add to itunes&quot; -Folder with originalname.m4v<br />and then delete the mov-file.<br /><br />Thanks for any assistens. <br /><br />Karl Oberreiter<br />ok@protop.com <br />Austria<br /></div>
</div>
</div>
