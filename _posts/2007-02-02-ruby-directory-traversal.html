---
layout: post
title: "Ruby - Directory Traversal"
date: 2007-02-02
comments: false
categories:
 - ruby
 - utility
 - scripting
---

<div class='post'>
Yesterday I needed to write another quick ruby script to traverse a directory tree, extract source code from a variety of file types and create one file that contained all of the extracted source code.  My initial thought was to use the <span class="kw">Dir</span> class; however, that resulted in a blind goose chase.<br /><br />It turns out you don't have to roll your own directory traversal using the <span class="kw">Dir</span> class (which was more than a little clunky to try to accomplish) instead you need to use the <span class="kw">Find</span> module (<a href="http://www.ruby-doc.org/core/classes/Find.html">documented here</a>).<br /><br />The nice thing was that once I found that module the script to accomplish my task was super easy to write (about 50 lines of code including comments/whitespace).  I chose to use a configuration file to hold some user-specified settings so that the tool could be used to process other types of projects (I processed a c# and asp.net project this time but will need to do the same to a CF project soon).<br /><br />Here is the code - if you see something that could be improved, please let me know in the comments.<br /><br /><pre name="code" class="ruby"><br />require 'find'<br />class PatentBuilder<br />def initialize()<br /> @rootDirectory =IO.readlines("patent.cfg")[1].strip!<br /> @includedFileTypes =IO.readlines("patent.cfg")[3].downcase.split(",")<br /> @excludedDirectoryNames =IO.readlines("patent.cfg")[5].downcase.split(",")<br /><br />puts @includedFileTypes<br />end<br /><br />def rootDirectory<br /> @rootDirectory<br />end<br /><br />def RecurseTree<br />outfile = File.new("patent_output.txt","w+");<br />totalFiles = 0;<br /> Find.find(@rootDirectory) do |path|<br /><br />  if FileTest.directory?(path)<br />   #determine if this is a directory we don't like...<br />   if @excludedDirectoryNames.include?(File.basename(path.downcase))<br />    Find.prune #don't look in this directory<br />   else<br />    outfile &lt;&lt; "// DIRECTORY: " &lt;&lt; path<br />    outfile &lt;&lt; "\n"<br />    next<br />   end<br />  else #we have a file<br />   filetype = File.basename(path.downcase).split(".").last<br />   if @includedFileTypes.include?(filetype)<br />    outfile &lt;&lt; "// FILE: " &lt;&lt; path<br />    outfile &lt;&lt; "\n"<br />    File.open(path).each do |line|<br />     outfile &lt;&lt; line<br />    end<br />    #puts path<br />    totalFiles = totalFiles + 1<br />    outfile &lt;&lt; "\n"<br />   else<br />   end<br /><br />  end<br /> end<br /> puts "total files = " &lt;&lt; totalFiles.to_s<br />end<br />end<br /><br /><br /><br /><br />PatentBuilder.new.RecurseTree<br /></pre><br /><br />The configuration file (named patent.cfg) is pretty simple and needs to go in the same directory as the ruby file (patent.rb):<br /><br /><pre name="code" class="ruby"><br />::Root Directory<br />c:\some\directory\path<br />::Included File Types (extensions)<br />cs,aspx,vb,asmx,css,xml,resx,ascx,master,sitemap,sql,<br />::Excluded Directory Names<br />Tests,Documentation,.svn,<br /></pre><br /><br />You may notice that each of my lists is comma separated and the final item in each list is trailed by a comma.  Without that trailing comma the code to split the string on the comma's lost the final token in my list.</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>breckenedge</div>
<div class='content'>
Ah thanks for the good example, I needed something like this.</div>
</div>
<div class='comment'>
<div class='author'>Eljay</div>
<div class='content'>
I didn't see the trailing comma in the patent.cfg.  Doh!<BR/><BR/>Instead, I changed the script to not need it.<BR/><BR/> @includedFileTypes =IO.readlines("patent.cfg")[3].downcase.chomp.split(",")<BR/> @excludedDirectoryNames =IO.readlines("patent.cfg")[5].downcase.chomp.split(",")</div>
</div>
<div class='comment'>
<div class='author'>Bill</div>
<div class='content'>
bear: thanks for the tip - I didn't just forget I could use that - I didn't even know it existed!</div>
</div>
<div class='comment'>
<div class='author'>bearontheroof</div>
<div class='content'>
dont forget you can use File.extname instead of manually pulling out the extension!</div>
</div>
<div class='comment'>
<div class='author'>Bill</div>
<div class='content'>
Yes that would be an improvement, though, really, the benefits gained from that bit of optimization would be pretty minimal.</div>
</div>
<div class='comment'>
<div class='author'>weeklymg</div>
<div class='content'>
On the 'could be improved' front, I'm no ruby expert, but aren't you reading your config file 3 times?   It seems like you could just assign IO.readlines to a variable and then access the 3 lines from it.</div>
</div>
<div class='comment'>
<div class='author'>errorval</div>
<div class='content'>
Sweeet. Thanks dude. I am using it as a base for around 500 files that need to be modified. Thanks a bunch!</div>
</div>
</div>
