---
layout: post
title: "Apache POI - Spreadsheets on the FLY"
date: 2006-08-04
comments: false
categories:
 - coldfusion
 - java
 - poi
---

<div class='post'>
Using CF 6.1 I have a task where I need to export a bunch of data to an excel spreadsheet.  Not wanting to use the html table with cfcontent headers method for streaming the excel data to the browser I decided to dive into the pond with Apache Poi.  Thanks to some blog posts by <a href="http://www.d-ross.org/index.cfm?objectid=9C65ECEC-508B-E116-6F8A9F878188D7CA">Dave Ross</a> and <a href="http://weblogs.macromedia.com/cantrell/archives/2003/06/using_coldfusio.cfm">Christian Cantrell</a> I was able to build my spreadsheet pretty quickly AND stream the contents to the user without having to create a spreadsheet on the server's filesystem.<br /><br />I'm not going to go into much detail on creating the spreadsheet since Dave's post goes into that with great detail.  However, I did have to add a touch of new logic to Christian's streaming solution in order to get it to work.<br /><br />The following function is a method within a "ExcelWriter" wrapper CFC I have for working with POI - just so my code elsewhere isn't muddied up with java calls.<br /><br /><pre name="code" class="coldfusion"><br />&lt;cffunction access="public" output="true" name="stream" returntype="void" hint="writes the spreadsheet to a bytearray output stream"&gt;<br />  &lt;cfset var o = "" /&gt;<br />  &lt;cfset var book = getBook() /&gt;<br />  &lt;cfset var context = "" /&gt;<br />  &lt;cfset var response = "" /&gt;<br />  &lt;cfset var outStream = createObject("java","java.io.ByteArrayOutputStream").init()/&gt;<br />  &lt;cfset var len = 0 /&gt;<br /><br />  &lt;cfset book.write(outStream) /&gt;<br />   &lt;cfscript&gt;<br />    book.write(outStream);<br />    len = arrayLen(outStream.toByteArray());<br />    outStream.flush();<br />    outStream.close(); <br /><br />       context = getPageContext();<br />       context.setFlushOutput(false);<br />       // must call getResponse twice to get to the correct output stream (otherwise it is a character output stream which will corrupt my binary data)<br />       response = context.getResponse().getResponse();<br />       out = response.getOutputStream();<br />       response.setContentType("application/vnd.ms-excel");<br />       response.setContentLength(len);<br />       book.write(out);<br />       out.flush();<br />       out.close();<br />   &lt;/cfscript&gt;<br /> &lt;/cffunction&gt;<br /></pre><br /><br />I'll be the first to admit that there may be a better way to get the length of the spreadsheet bytearray.  But this is the only way I know to do it.  If I didn't determine the byte array length then JRUN kind of hangs up if I try another request after the excel was streamed (unless I close the requesting browser).  I think, if you fail to provide a contentLength value to the response stream that it just keeps on streaming until it either times out or the request is killed (browser close).</div>
