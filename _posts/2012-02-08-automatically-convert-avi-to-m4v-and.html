---
layout: post
title: "Automatically convert .avi to .m4v and add to iTunes using Automator"
date: 2012-02-08
comments: false
categories:
 - m4v
 - conversion
 - folder-action
 - handbrake
 - mac
 - avi
 - applescript
 - automator
---

<div class='post'>
That is a long title but not nearly as long and arduous as my process of figuring out how to do what it says. &nbsp;Here is the scenario...<br /><br />Let's say you and your mom are sharing a dropbox folder and she plops in an .avi of her recent performance in the community theater where she lives. &nbsp;You don't really like the avi format and would prefer it in the m4v format and inside iTunes so you can watch it on your TV using your apple tv. &nbsp;What is one way to do that?<br /><br />Well, I'm going to tell you. &nbsp;Now, trust me, this probably isn't the best way; but it works and that's all I wanted. &nbsp;Initially I tried the export movies task in automator but the resultant video wasn't working in iTunes - I'm not sure why. &nbsp;Therefore I resulted to using the Handbrake CLI from within an apple script via automator. &nbsp;Here is the script:<br /><br /><br /><pre class="sql" name="code">on run {input, parameters}<br /> repeat with i in input<br />  try<br />   set text item delimiters to ":"<br />   set file_name to last text item of (i as text)<br />   set text item delimiters to ""<br />  on error<br />   set text item delimiters to ""<br />  end try<br />  <br />  set origFilepath to quoted form of POSIX path of (i as alias)<br />  set newFileName to "" &amp; (characters 1 thru -5 of file_name as string) &amp; ".m4v"<br />  set newFilepath to "/Users/me/mp4/" &amp; newFileName &amp; ""<br />  <br /><br />  --apple uses colons as delimiters while the  Untitled=drive; Users=directory; me=username; mp4=temp directory..<br />  set finalPath to ("Untitled:Users:me:mp4:" &amp; newFileName)<br />  <br />  <br />  --start the conversion; shell command uses the forward slash as the delimiter; hence two finalpath defined.<br />  set shellCommand to "nice /Applications/HandBrakeCLI -i " &amp; origFilepath &amp; " -o " &amp; newFilepath &amp; " --preset=\"AppleTV 2\";"<br />  do shell script shellCommand<br />  <br />  --I've told itunes to copy files on import; this way I don't have m4v's laying all over the place<br />  tell application "iTunes"<br />   add finalPath<br />  end tell<br />  <br />  --after the import is done I delete the m4v file I just created (from the temp directory)<br />  tell application "Finder"<br />   delete finalPath<br />  end tell<br />  <br /> end repeat<br /> <br /> return input<br />end run<br /></pre><br />Basically to use this you create a new automator "Folder Action" using an "Apple Script"  paste this entire thing into the script (replacing anything apple puts there by default).  Then pick the folder you want to watch.  I noticed that the task usually fires off about 10 seconds after an .avi file shows up in the directory.<br /><br />This still needs something to confirm the file that just plopped into the watch directory is an actual .avi file. &nbsp;I didn't worry about that though it is probably &nbsp;not too hard to add that check (though with apple script and its' crazy syntax I wouldn't bet on it).</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Juan Manuel Bosque</div>
<div class='content'>
This script runs perfecly. Congratulations.<br />Mi unique problem is that if the name of the source file cointains blank spaces, the output file result in a file without extension and it&#39;s not imported to itunes... :-\</div>
</div>
</div>
