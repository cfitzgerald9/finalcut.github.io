---
layout: post
title: "Autofac, Quartz.Net, and Azure Worker Roles"
description:
headline:
date: 2016-04-08 16:12:11 -0400
category: azure
tags: [azure,autofac,quartz,di,dependency-injection,scheduling,csharp]
imagefeature:
mathjax:
chart:
comments: true
featured: false
---

A couple caveats before I go into all of this:

1. I'm using Visual Studio 2012
2. I barely know what I'm doing with Autofac
3. I barely know what I'm doing with Quartz
4. I barely know what I'm doing with Azure Worker Roles

Okay, now that that is out of the way I'll get to the meat of this post.  Basically, I am working on an Azure web application and I have a bunch of different jobs I need to execute at various intervals.  I have one that processes and email queue (not using Azure Queues).  I have another that purges an event log in an Azure SQL database. I have a few others that take anywhere from 40-80 minutes to run really long processes on the same database in order to prepare a bunch of data for faster reporting.

I tried to use the Azure Web Jobs idea but creating little command line applications and then getting them deployed just kind of a sucked from a workflow process.  Maybe there is an easier
way to get them deployed but basically I had to build them, create a zip file of the release directory, and then upload that using the Azure Management Portal.  That sucked.  [This Guy](http://www.troyhunt.com/2015/01/azure-webjobs-are-awesome-and-you.html) makes them sound wonderful and, maybe they are, but I couldn't do the handy "New Azure Webjob Project" in Visual Studio 2012.  Yeah, I tried the [Visual Studio Extension](https://visualstudiogallery.msdn.microsoft.com/f4824551-2660-4afa-aba1-1fcc1673c3d0) which claims to work with VS 2012 but it doesn't.  So, in the end, I went in a big circle and ended up back with an Azure Worker Role.

I already figured out how to [deploy the worker role automatically using TeamCity](http://code.rawlinson.us/2016/04/deploying-azure-worker-role-via-team-city.html) so now I just had to build the role and get it to start scheduling jobs.  That's where this post comes into play.  In it I'm basically going to walk you through the construction of my entire project so far.  There will be large swaths of code.  Feel free to use whatever you want or suggest improvements if you'd prefer.

### Scheduling
I looked into [Hangfire](https://github.com/HangfireIO/Hangfire) and [Quartz.NET](http://www.quartz-scheduler.net/) and, frankly, Quartz.NET seemed easier to me.  It doesn't offer all the same cool power features that Hangfire does but I think it will suffice for my needs.  

One of the things I like about Quartz was the relative simplicity of configuring the job schedule and trigger.  I am still at a very basic level usage here so I haven't gotten to the point where I'm storing configuration information in the database.  Instead, each job I create (extending `IJob`) has a public static method called `Configure` that is responsible for providing all the schedule information for that job.  Here is an example:

```cs
public new static void Configure(IScheduler sch)
{
    IJobDetail job = JobBuilder.Create<PurgeEventLog>()
        .WithIdentity("PurgeEventLog", "admin")
        .Build();

    ITrigger trigger = TriggerBuilder.Create()
        .WithIdentity("PurgeEventLogTrigger", "admin")
        .WithSimpleSchedule(x => x
        .WithIntervalInSeconds(10)
        .WithInterval(new TimeSpan(1, 0, 0, 0, 0)) //one day
        .RepeatForever())
        .StartAt(new DateTimeOffset(2016, 1, 1, 22, 0, 0, new TimeSpan(0, 0, 0))) // starting at 10pm
        .Build();

    sch.ScheduleJob(job, trigger);
}
```

This job just runs once a day at 10pm each day.  Pretty simple to read and understand.  The Identity stuff let's you "group" your job and trigger; mine are in the "admin" gorup.  But, honestly, I don't know what that does yet.
