---
layout: post
title: "Javascript: Build TOC"
date: 2005-09-16
comments: false
categories:
 - javascript
 - table-of-contents
---

<div class='post'>
Today I saw a link to a script at javascript.com called BuildTOC.  The idea was actually a pretty good one but the implementation needed some work.  The description of the script raised the first flag - "IE only".  After digging into the script to figure out why it was IE only I found the second flag.  It was non-scemantic.  The <acronym title="Table of Contents">TOC</acronym> was in one unordered list, no nesting, and the appearance of structure as provided by increased margins via CSS.<br /><br />As you probably know it is best to separate presentation from content but the script was trying to use presentation to infer content.  That works great if you can see - but if you can't - then it seems like everything in the TOC is on the same level in the heirarchy.<br /><br />So, intrigued by the script, but disappointed by it's failings, I endeavoured to rewrite it.  Here is my final version. (<a href="http://rawlinson.us/toc.html">see a demo here</a>):<br /><br /><pre name="code" class="jscript"><br />var tocLevels = '6';<br /><br />function tocInit(){<br /> // because IE can't handle more than 6 levels; make sure the user hasn't exceeded that amount<br /> // if you remove this and use IE the script will no longer work if you have invalid H7 tags and beyond.<br /> if(tocLevels &gt; 6){<br />  tocLevels = 6;<br /> }<br /><br /> var tags = '';<br /> var tagNum = 0;<br /> var tagDetail = new Array(1);<br /> var tocTagList = '';<br /> var aNode = '';<br /><br /> //Build a list of the header tags<br /> for(var h=1;h&lt;=tocLevels;h++){<br />  tocTagList = tocTagList + 'H' + h + ',';<br /> }<br /><br /> //create an array of those tags<br /> var tocTagArray = tocTagList.split(',');<br /><br /><br /> var tags = document.getElementsByTagName("body")[0].childNodes;<br /><br /> // loop over all objects on the webpage looking for valid header tags<br /> for(var ti=0;ti&lt;tags.length;ti++){<br />  if (tocTagList.indexOf(tags[ti].tagName+',') != -1){<br /><br />   // this is used to buid the nested lists later<br />   currentLevel = tocTagArray.find(tags[ti].tagName);<br /><br />   //build a unique anchor to embed with the section header<br />   aNode = document.createElement('a');<br />   aNode.id = 'tocLink'+tagNum;<br />   tags[ti].appendChild(aNode);<br /><br /><br />   // collect some details about the section that we can use to build the TOC with<br />   tagDetail[tagNum] = tags[ti].tagName + '|' + tagNum + '|';<br />   if(tags[ti].childNodes.length){<br />    tagDetail[tagNum] = tagDetail[tagNum] + tags[ti].childNodes[0].nodeValue + '|' + currentLevel;<br />   } else {<br />    tagDetail[tagNum] = tagDetail[tagNum] + '&nbsp;' + '|' + currentLevel;<br />   }<br /><br />   tagNum++; // used to keep track of how many headers we have found. <br />  }<br /> }<br /><br /> tocBuild(tagDetail);<br /><br />}<br /><br /><br />function tocBuild(tagDetail){<br /><br /> var lastLevelNum = -1;<br /> var currentLevelNum = 0;<br /> var toc = getObjectRefByID('TOC');<br /> var currentParent = toc;<br /> var lastObject = currentParent;<br /><br /> for(var i = 0; i &lt; tagDetail.length; i++) {<br /> thisDetail = tagDetail[i].split("|");<br /><br /> currentLevelNum = thisDetail[3];<br /><br /> // created a nested unordered list..<br /> if(currentLevelNum &gt; lastLevelNum){<br />  var ulNode = document.createElement("ul");<br />  currentParent.appendChild(ulNode);<br />  currentParent = ulNode;<br /> }<br /> //move back up the DOM to the right level<br /> if(currentLevelNum &lt; lastLevelNum){<br />  var levelDiff = lastLevelNum - currentLevelNum;<br />  for(ldi=0;ldi&lt;levelDiff;ldi++){<br />   currentParent = currentParent.parentNode;<br />  }<br /> }<br /><br /> //add the new TOC entry<br /> var liNode = tocBuildEntry(thisDetail);<br /> currentParent.appendChild(liNode);<br /><br /> //keep track of where we are<br /> lastLevelNum = currentLevelNum;<br /> lastObject = liNode;<br /> }<br /><br />}<br /><br /><br />function tocBuildEntry(details){<br /><br /> var liNode = document.createElement("li");<br /> var aNode = document.createElement("a");<br /> var tNode = document.createTextNode(details[2]);<br /><br /> // className is the same as the tag, ie: H1, H2, etc.<br /> liNode.className = details[0];<br /> aNode.className = details[0];<br /><br /> //embed a link in the LI so we can jump to the correct section<br /> aNode.href = '#tocLink'+details[1];<br /> aNode.appendChild(tNode);<br /> liNode.appendChild(aNode);<br /><br /> return liNode;<br /><br />}<br /><br />/************************<br /> HELPER FUNCTIONS<br />*************************/<br />function addEvent(elm, evType, fn, useCapture)<br />// addEvent and removeEvent<br />// cross-browser event handling for IE5+,  NS6 and Mozilla<br />// By Scott Andrew<br />{<br />  if (elm.addEventListener){<br /> elm.addEventListener(evType, fn, useCapture);<br /> return true;<br />  } else if (elm.attachEvent){<br /> var r = elm.attachEvent("on"+evType, fn);<br /> return r;<br />  } else {<br /> alert("Handler could not be removed");<br />  }<br />} <br /><br /><br />function getObjectRefByID(objectId) {<br /> var element = false;<br /><br /> // cross-browser function to get an object given its id<br /> if(document.getElementById && document.getElementById(objectId)) {<br />  // W3C DOM<br />  element = document.getElementById(objectId);<br /> } <br /> else if (document.all && document.all(objectId)) {<br />  // MSIE 4 DOM<br />  element = document.all(objectId);<br /> } <br /> else if (document.layers && document.layers[objectId]) {<br />  // NN 4 DOM.. note: this won't find nested layers<br />  element = document.layers[objectId];<br /> } <br /><br /> return element;<br />} <br /><br /><br />if(Array.prototype.find){<br /> Array.prototype.find= null;<br />}<br />if(!Array.prototype.find) {<br /> function ArrayFind(value){<br />  // simply add the element to the end of the array changing the arrays<br />  // length by +1<br />  var index = -1;<br />  for(var i=0; i&lt;this.length;i++){<br />   if(this[i] == value){<br />    index = i;<br />    break;<br />   }<br />  }<br />  return index;<br /> }<br /> // set the Arrays push method equal to our ArrayPush function<br /> Array.prototype.find = ArrayFind;<br />} <br /><br /><br /><br />// builds the TOC when the page is loaded.<br />addEvent(window, "load", tocInit);<br /></pre></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Bill</div>
<div class='content'>
lol!  thanks</div>
</div>
<div class='comment'>
<div class='author'>Jeff Coughlin</div>
<div class='content'>
Ahh.  I get it :)<BR/><BR/>I think we are all plagued as developers to clean up code when we see poorly designed (or implimented) code.  (Zombie voice, "Must clean code").<BR/><BR/>Good job then :)</div>
</div>
<div class='comment'>
<div class='author'>Bill</div>
<div class='content'>
that's what my version of the script does and is one of the things I did to improve the version I saw at javascript.com<BR/><BR/>this script is purely meant as an exercise to fix the faults of the other script.<BR/><BR/>1. works in DOM compliant browsers<BR/>2. builds a nested unordered list to provide structure</div>
</div>
<div class='comment'>
<div class='author'>Jeff Coughlin</div>
<div class='content'>
Why not make it a nested unordered list and use CSS to display it properly (which should work in IE as well as other browsers)?<BR/><BR/>This will separate content from logic and will eliminate the need for javascript.<BR/><BR/>[ul]<BR/>--[li]Topic 1.0<BR/>----[ul]<BR/>------[li]Topic 1.1[/li]<BR/>------[li]Topic 1.2[/li]<BR/>----[/ul]<BR/>--[/li]<BR/>--[li]Topic 2.0[/li]<BR/>[/ul]</div>
</div>
</div>
