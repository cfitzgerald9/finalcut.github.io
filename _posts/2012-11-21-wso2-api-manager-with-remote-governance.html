---
layout: post
title: "WSO2 API Manager with Remote Governance"
date: 2012-11-21
comments: false
categories:
 - java
 - mysql
 - registry
 - wso2
 - governance
 - api-manager
---

<div class='post'>
NOTE: this article is superceded by my revised version at <a href="http://code.rawlinson.us/2012/11/wso2-api-manager-with-remote-governance_29.html">WSO2 API Manager with Remote Governance : The Mostly Complete Guide</a> - Please refer to it instead of this!  As you might have seen in<a href="http://code.rawlinson.us/2012/11/configure-wso2-api-manager-to-run-on.html"> my last post</a> I'm mucking around with the <a href="http://wso2.com/products/api-manager/">WSO2 API manager</a>. &nbsp;To be honest I don't really know what every component of the WSO2 stack is for yet but I'm slowly coming to terms with a few. &nbsp;Today, was the day to try to tie the<a href="http://wso2.com/products/governance-registry/"> WSO2 Governance Registry</a> into the mix by having my various API Manager nodes use remote governance. &nbsp;Now, honestly, I'm not sure what the governance registry does. &nbsp;However, some WSO2 people have suggested it should be setup as part of my distributed effort so I pursued it. &nbsp;Their website has a lot of jargon on it that makes the Governance Registry sound pretty important but; again, I'm just not sure what role it actually plays within the API Manager. I suspect it is what actually does the API consumption throttling based on the rules set in the API Publisher.<br /><br />Anyway, I started the process of setting up the remote governance by using&nbsp;<a href="http://ajithvblogs.blogspot.com/2012/09/create-jdbc-mount-to-wso2-governance.html">this blog post by Ajith</a> whom, as of this writing, is an employee of WOS2. &nbsp;However, there are some small errors in the blog posting and some areas where some clarification is needed so I'm basically going to rehash that article here with my corrections.<br /><br />Just like in Ajith's blog I am connecting to a mysql database. &nbsp;Except I'm connecting to it from some remote machines instead of from nodes on the same machine as the Governance Registry. &nbsp;This tutorial assumes mysql is already installed. &nbsp;I will refer to the Governance Registry as "GREG" at times.<br /><br /><h3>Setting up the Governance Registry</h3><ol><li>Create a new database within your mysql server:<br /><pre class="sql" name="code">$ mysql -u root -p<br />mysql&gt; create database api_greg;<br />mysql&gt; grant usage on *.* to username@'%' identified by 'somepassword';<br />mysql&gt; grant all privileges on api_greg.* to usrename@'%';<br /></pre>NOTE: I use the @'%' instead of @localhost so that my database doesn't have to know what hosts might be connecting.  I'd suggest you limit yours to a subnet or defined set of hosts for security purposes. </li><li>Update the GREG database configuration:<br />{GREG_HOME}/repository/conf/datasources/master-datasources.xml like so:<br /><pre class="xml" name="code">        &lt;datasource&gt;<br />            &lt;name&gt;WSO2_CARBON_DB&lt;/name&gt;<br />            &lt;description&gt;The datasource used for registry and user manager&lt;/description&gt;<br />            &lt;jndiConfig&gt;<br />                &lt;name&gt;jdbc/WSO2CarbonDB&lt;/name&gt;<br />            &lt;/jndiConfig&gt;<br />            &lt;definition type="RDBMS"&gt;<br />                &lt;configuration&gt;                                    &lt;url&gt;jdbc:mysql://{GREG_MYSQL_IP_OR_HOSTNAME}:3306/wso_greg?autoReconnect=true&amp;relaxAutoCommit=true&lt;/url&gt;<br />&lt;username&gt;standardstacks&lt;/username&gt;<br />                    &lt;password&gt;standardstacks&lt;/password&gt;                    &lt;driverClassName&gt;com.mysql.jdbc.Driver&lt;/driverClassName&gt;<br />                    &lt;maxActive&gt;50&lt;/maxActive&gt;<br />                    &lt;maxWait&gt;60000&lt;/maxWait&gt;<br />                    &lt;testOnBorrow&gt;true&lt;/testOnBorrow&gt;<br />                    &lt;validationQuery&gt;SELECT 1&lt;/validationQuery&gt;<br />                    &lt;validationInterval&gt;30000&lt;/validationInterval&gt;<br />                &lt;/configuration&gt;<br />            &lt;/definition&gt;<br />        &lt;/datasource&gt;<br /><br /></pre></li><li>edit {GREG_HOME}/repository/conf/datasources/axis2/axis2.xml and enable clustering by setting the enable attribute to true.  This is around line 541:<br /><pre class="xml" name="code"> &lt;clustering class="org.apache.axis2.clustering.tribes.TribesClusteringAgent" enable="true"&gt;</pre></li><li>Make sure the<a href="http://dev.mysql.com/downloads/connector/j/"> mysql jdbc driver</a> jar file is in the {GREG_HOME}/repository/component/lib directory</li><li>Start GREG with the -Dsetup switch:<br /><pre class="sql" name="code">$ cd {GREG_HOME}/bin<br />$ ./wso2server -Dsetup<br /></pre></li></ol><h3>Setting up an API Manager Node to use the Remote Governance</h3>I'll refer to the API Manager as APIM from here on out. &nbsp;All of the APIM nodes that will talk to the previously configured GREG need to be configured as follows:<br /><ol><li>Add a GREG datasource to your {APIM_HOME}/repository/conf/datasources/master-datasources.xml file<br /><pre class="xml" name="code">&lt;datasource&gt;<br />    &lt;name&gt;WSO2_CARBON_DB_GREG&lt;/name&gt;<br />    &lt;description&gt;The datasource used for registry &lt;/description&gt;<br />    &lt;jndiConfig&gt;<br />        &lt;name&gt;jdbc/WSO2CarbonDB_GREG&lt;/name&gt;<br />    &lt;/jndiConfig&gt;<br />    &lt;definition type="RDBMS"&gt;<br />    &lt;configuration&gt;<br />            &lt;url&gt;jdbc:mysql://{GREG_MYSQL_IP_OR_HOSTNAME}:3306/wso_greg?autoReconnect=true&amp;relaxAutoCommit=true&lt;/url&gt;<br />&lt;username&gt;standardstacks&lt;/username&gt;<br />            &lt;password&gt;standardstacks&lt;/password&gt;<br />            &lt;driverClassName&gt;com.mysql.jdbc.Driver&lt;/driverClassName&gt;<br />            &lt;maxActive&gt;50&lt;/maxActive&gt;<br />            &lt;maxWait&gt;60000&lt;/maxWait&gt;<br />            &lt;testOnBorrow&gt;true&lt;/testOnBorrow&gt;<br />            &lt;validationQuery&gt;SELECT 1&lt;/validationQuery&gt;<br />            &lt;validationInterval&gt;30000&lt;/validationInterval&gt;<br />    &lt;/configuration&gt;<br />    &lt;/definition&gt;<br />&lt;/datasource&gt;<br /></pre></li><li>Edit your {APIM_HOME}/repository/conf/registry.xml file and insert the following four nodes at the end of the file just before the closing node &lt;/wso2registry&gt;<br /><pre class="xml" name="code">&lt;dbConfig name="mounted_registry"&gt;<br />    &lt;dataSource&gt;jdbc/WSO2CarbonDB_GREG&lt;/dataSource&gt;<br />&lt;/dbConfig&gt;<br /><br />&lt;remoteInstance url="https://{GREG_IP_OR_HOSTNAME}:9464/registry"&gt;<br />                &lt;id&gt;instanceid&lt;/id&gt;<br />                &lt;dbConfig&gt;mounted_registry&lt;/dbConfig&gt;<br />                &lt;readOnly&gt;false&lt;/readOnly&gt;<br />                &lt;enableCache&gt;true&lt;/enableCache&gt;<br />                &lt;registryRoot&gt;/&lt;/registryRoot&gt;<br />&lt;/remoteInstance&gt;<br /><br />&lt;mount overwrite="true" path="/_system/config"&gt;<br />            &lt;instanceId&gt;instanceid&lt;/instanceId&gt;<br />            &lt;targetPath&gt;/_system/nodes&lt;/targetPath&gt;<br />&lt;/mount&gt;<br /><br />&lt;mount overwrite="true" path="/_system/governance"&gt;<br />            &lt;instanceId&gt;instanceid&lt;/instanceId&gt;<br />            &lt;targetPath&gt;/_system/governance&lt;/targetPath&gt;<br />&lt;/mount&gt;<br /></pre></li><li>Enable clustering in axis2&nbsp;{APIM_HOME}/repository/conf/datasources/axis2/axis2.xml<br /><pre class="xml" name="code"> &lt;clustering class="org.apache.axis2.clustering.tribes.TribesClusteringAgent" enable="true"&gt;</pre></li><li>Make sure the<a href="http://dev.mysql.com/downloads/connector/j/">&nbsp;mysql jdbc driver</a>&nbsp;jar file is in the {GREG_HOME}/repository/component/lib directory</li><li>Start the APIM node&nbsp; <pre class="sql" name="code">$ cd {APIM_HOME}/bin<br />$ ./wso2server</pre></li><li>Once the APIM starts you'll see some records like this in the console log: <pre class="xml" name="code">[2012-11-21 10:03:52,652]  INFO - EmbeddedRegistryService Configuredry in 674ms<br />[2012-11-21 10:03:52,875]  INFO - EmbeddedRegistryService Connected to mount at mounted_registry in 9ms<br />[2012-11-21 10:03:53,675]  INFO - EmbeddedRegistryService Connected to mount at mounted_registry in 0ms<br />[2012-11-21 10:03:53,834]  INFO - RegistryCoreServiceComponent Registry Mode    : READ-WRITE<br /></pre>Those should appear fairly early in the log - but they can be hard to see sometimes.  You can also check the management console by going to the Main tab | Resources Accordian | Browse Option.  Once there expand the _system node in the main panel.  If the config and governance have a folder with an arrow on them they are connecting to the remote governance registry.  Congratulations! </li></ol><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-55nUVo1hTPY/UKz9IQ0gjvI/AAAAAAADDtU/jlZHbi5LvCk/s1600/api_manager_remote_governance.gif" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="210" src="http://2.bp.blogspot.com/-55nUVo1hTPY/UKz9IQ0gjvI/AAAAAAADDtU/jlZHbi5LvCk/s320/api_manager_remote_governance.gif" width="320" /></a></div><div><br /></div><br />NOTE: please make sure the camelCase used in all of my example XML matches what you are putting into your files. &nbsp;If you don't use the right case the settings won't be picked up and you'll potentially see errors like<br /><pre class="xml" name="code">WARN {org.wso2.carbon.registry.core.config.RegistryConfigurationProcessor} -  The instance     identifier was not specified for the mount: /_system/config {org.wso2.carbon.registry.core.config.RegistryConfigurationProcessor}<br /></pre><br /><br /></div>
