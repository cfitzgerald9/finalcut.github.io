---
layout: post
title: "WSO2 API Manager with Remote Governance : The Mostly Complete Guide"
date: 2012-11-29
comments: false
categories:
 - remote-governance
 - java
 - api
 - mysql
 - registry
 - greg
 - wso2
 - api-manager
---

<div class='post'>
This is a mostly complete rewrite of the article that I previously wrote with the same name.  I am doing this because I made some mistakes the first time around.<br />As you might have seen in<a href="http://code.rawlinson.us/2012/11/configure-wso2-api-manager-to-run-on.html"> my last post</a> I'm mucking around with the <a href="http://wso2.com/products/api-manager/">WSO2 API manager</a>. &nbsp;To be honest I don't really know what every component of the WSO2 stack is for yet but I'm slowly coming to terms with a few. &nbsp;Today, was the day to try to tie the<a href="http://wso2.com/products/governance-registry/"> WSO2 Governance Registry</a> into the mix by having my various API Manager nodes use remote governance. &nbsp;Now, honestly, I'm not sure what the governance registry does. &nbsp;However, some WSO2 people have suggested it should be setup as part of my distributed effort so I pursued it. &nbsp;Their website has a lot of jargon on it that makes the Governance Registry sound pretty important but; again, I'm just not sure what role it actually plays within the API Manager. I suspect it is what actually does the API consumption throttling based on the rules set in the API Publisher.<br />Anyway, I started the process of setting up the remote governance by using&nbsp;<a href="http://ajithvblogs.blogspot.com/2012/09/create-jdbc-mount-to-wso2-governance.html">this blog post by Ajith</a> whom, as of this writing, is an employee of WOS2. &nbsp;However, there are some small errors in the blog posting and some areas where some clarification is needed so I'm basically going to rehash that article here with my corrections.<br />Before I get into configuration specifics here is the basic setup.  I'm running four api manager (APM) nodes and a single Governance Registry (GREG) node.  I'm also using mysql as my database for all data storage.  I am not currently using a Business Activity Monitor (BAM) becuase I haven't been able to get one to work.<br />My four APM nodes are broken down like this - a store, a publisher, a keymanager, and a gateway.  The store and publisher are Jaggery (server side javascript) apps that depend on some core WSO2 carbon stuff on the server.  Both the store and the publisher are configured to use the gateway and keystore.  The gateway is where API requests are sent by those people using APIs they subscribe to via the store.  The keymanager serves two roles; first it controls user authentication into the Store, the Publisher, and the "Carbon Console" which is sort of a management application all of the various WSO2 carbon apps have built in.  The second role of the keymanager is to issue API keys and authenticate applications that are attempting to use an API - thus the gateway is also configured to use the keymanager.<br />I've created four mysql databases for the purpose of this example - and I advise you to separate out your databases in a similar fashion.<br /><dl><dt>api_mgr</dt><dd>This is where API information stored and fetched by the four APM nodes</dd><dt>api_grg</dt><dd>This is a registry database used by the GREG and the various APM nodes. &nbsp;User information will also end up being stored here.</dd></dl>NOTE: The structure of the api_usr, api_reg, and api_grg databases are all identical.  However, not all tables are actually used within each database.<br /><h3>Database Setup</h3>Here is a quick script to create the databases, create the user "wso2carbon" with password (identified by) "wso2carbon" and to grant access to that user from any other remote host to the four databases<br /><pre class="xml" name="code"></pre><pre class="xml" name="code">mysql&gt; create database api_mgt;<br />Query OK, 1 row affected (0.00 sec)<br /><br />mysql&gt; create database api_grg;<br />Query OK, 1 row affected (0.00 sec)<br /><br />mysql&gt; grant usage on *.* to wso2carbon@'%' identified by 'wso2carbon';<br />Query OK, 0 rows affected (0.00 sec)<br /><br />mysql&gt; grant all privileges on api_mgt.* to wso2carbon@'%';<br />Query OK, 0 rows affected (0.00 sec)<br /><br />mysql&gt; grant all privileges on api_grg.* to wso2carbon@'%';<br />Query OK, 0 rows affected (0.00 sec)<br /></pre><br />For the most part the APM and GREG nodes, when started the first time (with a special switch of -Dsetup) will create the necessary tables for each of those databases with the exception of the api_mgr table.  There is a script in the {APM_NODE}/dbscripts/apimgt directory named mysql.sql that will create the api_mgr tables.  Thus, from the command line (shell) switch to the {APM_NODE}/dbscripts/apimgt directory, then connect to mysql and run the following commands: <br /><pre class="xml" name="code">$ mysql -uroot -ppassword<br />mysql&gt; \u api_mgt<br />mysql&gt; \. mysql.sql<br /></pre>That will 1. log you into mysql as root (using default authorization credentials) 2. tell mysql to use the api_mgt database and 3. execute the mysql.sql script in the current directory ({APM_NODE/dbscripts/apimgt}). Once the script is completed you'll have the following tables<br /><pre>+-------------------------------+<br />| table_name                    |<br />+-------------------------------+<br />| AM_API                        |<br />| AM_API_LC_EVENT               |<br />| AM_APPLICATION                |<br />| AM_APPLICATION_KEY_MAPPING    |<br />| AM_SUBSCRIBER                 |<br />| AM_SUBSCRIPTION               |<br />| AM_SUBSCRIPTION_KEY_MAPPING   |<br />| IDN_BASE_TABLE                |<br />| IDN_OAUTH1A_ACCESS_TOKEN      |<br />| IDN_OAUTH1A_REQUEST_TOKEN     |<br />| IDN_OAUTH2_ACCESS_TOKEN       |<br />| IDN_OAUTH2_AUTHORIZATION_CODE |<br />| IDN_OAUTH_CONSUMER_APPS       |<br />+-------------------------------+<br /></pre>TIP: That list of tables was aquired with the query:<br /><pre class="sql" name="code"> SELECT table_name FROM information_schema.tables WHERE table_schema = 'api_mgr';<br /></pre>Later, after ALL the configuration is done, we will be starting the keymanager APM node and the GREG node with the switch -Dsetup which will create the the necessary tables in the other three databases.<br /><h3>Setting up the Governance Registry (GREG)</h3>Overall setting the GREG up and getting it running is pretty straight forward.  We just have to edit a couple files before we start it up. <br /><h4>Define your Datasources</h4>In order to define the datasources you need to edit the file at {GREG_ROOT}/repository/conf/datasources/master-datasources.xml.  There are some sample configuration values in there which you'll be editing as well as adding a new one. <br /><h5>WSO2_CARBON_DB</h5>This is the datasource that will point at the api_grg database we created earlier. <br /><pre class="xml" name="code">        &lt;datasource&gt;<br />            &lt;name&gt;WSO2_CARBON_DB&lt;/name&gt;<br />            &lt;description&gt;The datasource used for registry and user manager&lt;/description&gt;<br />            &lt;jndiConfig&gt;<br />                &lt;name&gt;jdbc/WSO2CarbonDB&lt;/name&gt;<br />            &lt;/jndiConfig&gt;<br />            &lt;definition type="RDBMS"&gt;<br />                &lt;configuration&gt;<br />                    &lt;url&gt;jdbc:mysql://{MYSQL_IP_ADDRESS}:3306/api_grg?autoReconnect=true&amp;amp;relaxAutoCommit=true&lt;/url&gt;<br />                    &lt;username&gt;wso2carbon&lt;/username&gt;<br />                    &lt;password&gt;wso2carbon&lt;/password&gt;<br />                    &lt;driverClassName&gt;com.mysql.jdbc.Driver&lt;/driverClassName&gt;<br />                    &lt;maxActive&gt;50&lt;/maxActive&gt;<br />                    &lt;maxWait&gt;60000&lt;/maxWait&gt;<br />                    &lt;testOnBorrow&gt;true&lt;/testOnBorrow&gt;<br />                    &lt;validationQuery&gt;SELECT 1&lt;/validationQuery&gt;<br />                    &lt;validationInterval&gt;30000&lt;/validationInterval&gt;<br />                &lt;/configuration&gt;<br />            &lt;/definition&gt;<br />        &lt;/datasource&gt;<br /></pre>NOTE: Every mysql datasource you define will need to have the ?autoReconnect=true&amp;amp;relaxAutoCommit=true arguments included.  If you forget them you'll see all sorts of errors later about how the database couldn't commit something that is already committed.  Also note the &amp;amp; part has to be encoded because it is in an XML file.<br /><br />Now that the datasources are defined you're almost done configuring the GREG.  The WSO2_CARBON_DB changes will be picked up automatically.<br /><br />Now, we need to set the "port offset" so that you minimize the risk of having one WSO2 node conflict with another that ends up being on the same server.  For the case of these examples we will use an offset value in the 40's.  To set the offset go to {GREG_ROOT}/repository/conf/carbon.xml and find the node titled Ports.  A subnode of that is Offset; change it like so:<br /><pre class="xml" name="code">    &lt;Ports&gt;<br /><br />        &lt;!-- Ports offset. This entry will set the value of the ports defined below to<br />         the define value + Offset.<br />         e.g. Offset=2 and HTTPS port=9443 will set the effective HTTPS port to 9445<br />         --&gt;<br />        &lt;Offset&gt;49&lt;/Offset&gt;<br />        ...<br /></pre>I set the GREG offset to be at the end of the 40's and I will use the lower part of the 40's for the APM nodes.<br />There is just one last step - the GREG needs to have clustering turned on (even if it is the only GREG node). To turn on clustering edit {GREG_HOME}/repository/conf/axis2/axis2.xml:<br /><pre class="xml" name="code">    &lt;clustering class="org.apache.axis2.clustering.tribes.TribesClusteringAgent" enable="true"&gt;<br /></pre>At this point the GREG is setup.  You can start it by going to the {GREG_ROOT}/bin directory then running the setup script appropriate for your platform.<br /><br /><br /><pre class="sql" name="code">$ cd {GREG_HOME}/bin<br />$ ./wso2server.sh -Dsetup<br /></pre>NOTE: In the future if you have to restart it make sure you don't use the -Dsetup switch.<br /><br />NOTE: If you get errors about being unable to connect to the database server refer to<a href="http://www.cyberciti.biz/tips/how-do-i-enable-remote-access-to-mysql-database-server.html"> this article on enabling remote access to mysql server</a>.<br /><h3>APM Setup</h3>When all is said and done you'll have four APM nodes created but I suggest you just start with one.  We have to do some identical configuration on each of them so this way you can just do some changes to one node, then copy it three more times thus saving you from having to edit the same files in each node.  This initial node I'll refer to as APM_NODE and it's root directory as {APM_NODE_ROOT}.<br /><h4>Setting up the databases</h4>Just like with the GREG we have to edit the {APM_NODE_ROOT}/repository/conf/datasources/master-datasources.xml file.  First off just leave the WSO2_CARBON_DB alone - it points to an H2 database. &nbsp;We will just let it continue to do so. &nbsp;It doesn't matter that each of the nodes will point to separate H2 databases.<br /><br />We need to update the WSO2_AM_DB to point to our api_mgr database:<br /><pre class="xml" name="code">        &lt;datasource&gt;<br />            &lt;name&gt;WSO2AM_DB&lt;/name&gt;<br />            &lt;description&gt;The datasource used for API Manager database&lt;/description&gt;<br />            &lt;jndiConfig&gt;<br />                &lt;name&gt;jdbc/WSO2AM_DB&lt;/name&gt;<br />            &lt;/jndiConfig&gt;<br />            &lt;definition type="RDBMS"&gt;<br />                &lt;configuration&gt;<br />                    &lt;url&gt;jdbc:mysql://{MYSQL_IP_ADDRESS}:3306/api_mgt?autoReconnect=true&amp;amp;relaxAutoCommit=true&lt;/url&gt;<br />                    &lt;username&gt;wso2carbon&lt;/username&gt;<br />                    &lt;password&gt;wso2carbon&lt;/password&gt;<br />                    &lt;driverClassName&gt;com.mysql.jdbc.Driver&lt;/driverClassName&gt;<br />                    &lt;maxActive&gt;50&lt;/maxActive&gt;<br />                    &lt;maxWait&gt;60000&lt;/maxWait&gt;<br />                    &lt;testOnBorrow&gt;true&lt;/testOnBorrow&gt;<br />                    &lt;validationQuery&gt;SELECT 1&lt;/validationQuery&gt;<br />                    &lt;validationInterval&gt;30000&lt;/validationInterval&gt;<br />                &lt;/configuration&gt;<br />            &lt;/definition&gt;<br />        &lt;/datasource&gt;<br /></pre>And lastly we need to create a WSO2_GREG_DB datasource that points to the api_grg database:<br /><pre class="xml" name="code">        &lt;datasource&gt;<br />            &lt;name&gt;WSO2_GREG_DB&lt;/name&gt;<br />            &lt;description&gt;The datasource used for registry &lt;/description&gt;<br />            &lt;jndiConfig&gt;<br />                &lt;name&gt;jdbc/WSO2_GREG_DB&lt;/name&gt;<br />            &lt;/jndiConfig&gt;<br />            &lt;definition type="RDBMS"&gt;<br />            &lt;configuration&gt;<br />                    &lt;url&gt;jdbc:mysql://{MYSQL_IP_ADDRESS}:3306/api_grg?autoReconnect=true&amp;amp;relaxAutoCommit=true&lt;/url&gt;<br />                    &lt;username&gt;wso2carbon&lt;/username&gt;<br />                    &lt;password&gt;wso2carbon&lt;/password&gt;<br />                    &lt;driverClassName&gt;com.mysql.jdbc.Driver&lt;/driverClassName&gt;<br />                    &lt;maxActive&gt;50&lt;/maxActive&gt;<br />                    &lt;maxWait&gt;60000&lt;/maxWait&gt;<br />                    &lt;testOnBorrow&gt;true&lt;/testOnBorrow&gt;<br />                    &lt;validationQuery&gt;SELECT 1&lt;/validationQuery&gt;<br />                    &lt;validationInterval&gt;30000&lt;/validationInterval&gt;<br />            &lt;/configuration&gt;<br />            &lt;/definition&gt;<br />        &lt;/datasource&gt;<br /></pre>Honestly, the name you use for the WSO2_GREG_DB isn't that important so long as it is unique within that file. Just make it something recognizable for it's purpose. At this point all of our datasources are defined so we need to put them into affect.<br />We need to update the user-mgt.xml file in {APM_NODE_ROOT}/repository/conf/user-mgt.xml because we are storing our user information in the shared GREG database.<br /><br /><pre class="xml" name="code">        &lt;Configuration&gt;<br />                &lt;AdminRole&gt;admin&lt;/AdminRole&gt;<br />                &lt;AdminUser&gt;<br />                     &lt;UserName&gt;admin&lt;/UserName&gt;<br />                     &lt;Password&gt;admin&lt;/Password&gt;<br />                &lt;/AdminUser&gt;<br />            &lt;EveryOneRoleName&gt;everyone&lt;/EveryOneRoleName&gt; &lt;!-- By default users in this role sees the registry root --&gt;<br />            &lt;Property name="dataSource"&gt;jdbc/WSO2_GREG_DB&lt;/Property&gt;<br />            &lt;Property name="MultiTenantRealmConfigBuilder"&gt;org.wso2.carbon.user.core.config.multitenancy.SimpleRealmConfigBuilder&lt;/Property&gt;<br />        &lt;/Configuration&gt;<br /></pre><br /><br />Just as an FYI - the GREG database looks like this:<br /><br />+-----------------------+<br /><pre>| TABLES                |<br />+-----------------------+<br />| REG_ASSOCIATION       |<br />| REG_CLUSTER_LOCK      |<br />| REG_COMMENT           |<br />| REG_CONTENT           |<br />| REG_CONTENT_HISTORY   |<br />| REG_LOG               |<br />| REG_PATH              |<br />| REG_PROPERTY          |<br />| REG_RATING            |<br />| REG_RESOURCE          |<br />| REG_RESOURCE_COMMENT  |<br />| REG_RESOURCE_HISTORY  |<br />| REG_RESOURCE_PROPERTY |<br />| REG_RESOURCE_RATING   |<br />| REG_RESOURCE_TAG      |<br />| REG_SNAPSHOT          |<br />| REG_TAG               |<br />| UM_CLAIM              |<br />| UM_CLAIM_BEHAVIOR     |<br />| UM_DIALECT            |<br />| UM_HYBRID_REMEMBER_ME |<br />| UM_HYBRID_ROLE        |<br />| UM_HYBRID_USER_ROLE   |<br />| UM_PERMISSION         |<br />| UM_PROFILE_CONFIG     |<br />| UM_ROLE               |<br />| UM_ROLE_PERMISSION    |<br />| UM_TENANT             |<br />| UM_USER               |<br />| UM_USER_ATTRIBUTE     |<br />| UM_USER_PERMISSION    |<br />| UM_USER_ROLE          |<br />+-----------------------+<br /></pre>The tables prefixed with REG are registry tables. &nbsp;The tables prefixed with UM are user management tables.<br /><br />Next we need to tie the GREG into the APM node.  To do that we have to edit the {APM_NODE_ROOT}/repository/conf/registry.xml.  There are three xml nodes we will be adding; I put them right near the top just after the opening wso2registry tag.<br /><pre class="xml" name="code">    &lt;dbConfig name="mounted_registry"&gt;<br />        &lt;dataSource&gt;jdbc/WSO2_GREG_DB&lt;/dataSource&gt;<br />    &lt;/dbConfig&gt;<br /><br />    &lt;remoteInstance url="https://{GREG_HOST_IP}:9492/registry"&gt;<br />                    &lt;id&gt;instanceid&lt;/id&gt;<br />                    &lt;dbConfig&gt;mounted_registry&lt;/dbConfig&gt;<br />                    &lt;readOnly&gt;false&lt;/readOnly&gt;<br />                    &lt;enableCache&gt;true&lt;/enableCache&gt;<br />                    &lt;registryRoot&gt;/&lt;/registryRoot&gt;<br />    &lt;/remoteInstance&gt;<br /><br />    &lt;mount overwrite="true" path="/_system/governance"&gt;<br />                &lt;instanceId&gt;instanceid&lt;/instanceId&gt;<br />                &lt;targetPath&gt;/_system/governance&lt;/targetPath&gt;<br />    &lt;/mount&gt;<br /></pre><br />Some online tutorials will havea &nbsp;mount for /_system/config - don't include that. &nbsp;It is a holdover from where the API Manager is based on the WSO2 ESB. &nbsp;The API Manager doesn't share config info between nodes. It is possible that including the config node could cause problems.<br /><br />You'll notice that I have the port number of 9492 listed in that example. That is based on you using the OFFSET value of 49 that I mentioned in the GREG setup example above.  If you used a different offset value you'll need to figure out the port.  The easiest way is to start the GREG and, when it is done starting look for a line like this:<br /><pre> INFO {org.wso2.carbon.ui.internal.CarbonUIServiceComponent} -  Mgt Console URL  : https://GREG_IP_ADDRESS:9492/carbon/<br /></pre>The port that the console is available on is the same port the registry is available on.<br />At this point you've done all the generic setup we can do on the APM nodes.  So it's time to copy the node in order to create the various nodes we need.<br /><pre class="xml" name="code">$ cp -r node store<br />$ cp -r node publisher<br />$ cp -r node gateway<br />$ cp -r node keymanager<br /></pre><h3>The Key Manager</h3>Setting up the key manager is pretty straight forward.  We just have to edit a few configuration files.  The configuration files are all located in the {KEYMANAGER_HOME}/repository/conf directory (or subdirectories) so I'll refer to that directory as {KEY_CONF_HOME}.<br />First things first let's set the Port Offset to 41. To do that edit {KEY_CONF_HOME/carbon.xml like so:<br /><pre class="xml" name="code">        ...<br />    &lt;Ports&gt;<br /><br />        &lt;!-- Ports offset. This entry will set the value of the ports defined below to<br />         the define value + Offset.<br />         e.g. Offset=2 and HTTPS port=9443 will set the effective HTTPS port to 9445<br />         --&gt;<br />        &lt;Offset&gt;41&lt;/Offset&gt;<br />        ...<br /></pre>Next up we need to edit the {KEY_CONF_HOME}api-manager.xml file.  Basically just search for each of the nodes listed here and change them to the appropriate values:<br /><pre class="xml" name="code">    ...<br />    &lt;SignatureAlgorithm&gt;SHA256withRSA&lt;/SignatureAlgorithm&gt;<br />    ...<br />    &lt;EnableTokenGeneration&gt;true&lt;/EnableTokenGeneration&gt;<br />    ...<br />    &lt;EnableKeyMgtValidationInfoCache&gt;false&lt;/EnableKeyMgtValidationInfoCache&gt;<br />    ...<br /></pre>Assuming you'll be putting these nodes in production the WSO2 folks advise you make the following changes as well.  First off we need to edit the {KEY_CONF_HOME}/axis2/axis2_client.xml file:<br /><pre class="xml" name="code">    ...<br />    &lt;parameter name="defaultMaxConnPerHost"&gt;1000&lt;/parameter&gt;<br />    &lt;!-- commons-http-client maxTotalConnections --&gt;<br />    &lt;parameter name="maxTotalConnections"&gt;30000&lt;/parameter&gt;<br />    ...<br /></pre>Then you need to edit {KEY_CONF_HOME}/tomcat/catalina-server.xml and change the following attributes of the Connector tag:<br /><pre class="xml" name="code">    maxThreads="750"<br />    minSpareThreads="150"<br />    disableUploadTimeout="false"<br />    connectionUploadTimeout="120000"<br />    maxKeepAliveRequests="600"<br />    acceptCount="600"<br /></pre>At this point the keymanager configuration is completed.  So let's start it up to make sure everything is kosher.  Plus, we can take this opportunity to use have it initialize the other two databases (api_usr and api_reg).  In order to start it go to the {KEYMANAGER_HOME}/bin and run the startup script:<br /><pre class="sql" name="code">$ cd {KEYMANAGER_HOME}/bin<br />$ ./wso2server.sh<br /></pre><h3>The Gateway</h3>The gateway is responsible for handling all API requests, verifying the API key included in the request with the keymanager, and making sure the requestor has remaining quota left with the GREG and then finally passing the request tot he actual API endpoint, getting the response from the API endpoint,and sending that response back to the initial requester.  To set it up we will be editing the same files as we did the keymanager but with a few different modifications.<br />I'll refer to the {GATEWAY_HOME}/repository/conf directory as {GATEWAY_CONF}.  To start with we need to edit the {GATEWAY_CONF}/carbon.xml file to set the Port Offset.   <br /><h5>Port Offset</h5><pre class="xml" name="code">        ...<br />    &lt;Ports&gt;<br /><br />        &lt;!-- Ports offset. This entry will set the value of the ports defined below to<br />         the define value + Offset.<br />         e.g. Offset=2 and HTTPS port=9443 will set the effective HTTPS port to 9445<br />         --&gt;<br />        &lt;Offset&gt;42&lt;/Offset&gt;<br />        ...<br /></pre>Honestly, even when I'm installing all of these things on different servers I'd do this - it isn't necessary but it gets me in the habit and that way I don't forget to change the Offset when I do install things on the same server.  You should probably keep a log file that is shared by your team/department of what component has what offset on what server for ALL of your WSO2 installs so that you don't end up creating a conflict inadvertently down the road.<br /><h5>API Manager Config File</h5>Right off the bat we need to point the gateway at the keymanager; otherwise it can't verify key values that are passed to it.  To do this you'll need to edit {GATEWAY_CONF}/api-manager.xml.  After you make that change keep the file open as I'll discuss a few more changes:<br /><pre class="xml" name="code">    &lt;APIKeyManager&gt;<br />        &lt;ServerURL&gt;https://{KEYMANAGER_IP}:9484/services/&lt;/ServerURL&gt;<br />        &lt;Username&gt;admin&lt;/Username&gt;<br />        &lt;Password&gt;admin&lt;/Password&gt;<br />        &lt;EnableJWTCache&gt;false&lt;/EnableJWTCache&gt;<br />        &lt;EnableKeyMgtValidationInfoCache&gt;true&lt;/EnableKeyMgtValidationInfoCache&gt;<br />        &lt;KeyValidatorClientType&gt;ThriftClient&lt;/KeyValidatorClientType&gt;<br />        &lt;ThriftClientPort&gt;10397&lt;/ThriftClientPort&gt;<br />        &lt;ThriftClientConnectionTimeOut&gt;10000&lt;/ThriftClientConnectionTimeOut&gt;<br />        &lt;ThriftServerPort&gt;10398&lt;/ThriftServerPort&gt;<br />        &lt;EnableThriftServer&gt;false&lt;/EnableThriftServer&gt;<br />       &lt;!-- &lt;RemoveUserNameToJWTForApplicationToken&gt;true&lt;/RemoveUserNameToJWTForApplicationToken&gt;--&gt;<br />    &lt;/APIKeyManager&gt;<br /></pre>Your api-manager.xml file will have a bunch of comments in between the various settings. I just removed them to condense the values for display here.<br /><br />NOTE: you MUST turn off the ThriftServer by setting the &lt;EnableThriftServer&gt; value to false.<br />NOTE: the port of 9484 used in the ServerURL is based on the keymanager having a Port Offset of 41.  If you didn't use 41 you can see the value in the terminal for your keymanager: <br /><pre>[2012-11-28 14:42:27,031]  INFO - CarbonUIServiceComponent Mgt Console URL  : https://198.183.217.190:9484/carbon/<br /></pre>Next up we need to enable the Gateway key cache in the APIGateway node:<br /><pre class="xml" name="code">    &lt;APIGateway&gt;<br />        &lt;ServerURL&gt;https://${carbon.local.ip}:${mgt.transport.https.port}/services/&lt;/ServerURL&gt;<br />        &lt;Username&gt;admin&lt;/Username&gt;<br />        &lt;Password&gt;admin&lt;/Password&gt;<br />        &lt;APIEndpointURL&gt;http://${carbon.local.ip}:${http.nio.port},https://${carbon.local.ip}:${https.nio.port}&lt;/APIEndpointURL&gt;<br />        &lt;EnableGatewayKeyCache&gt;true&lt;/EnableGatewayKeyCache&gt;<br />    &lt;/APIGateway&gt;<br /></pre>Basically, you're just changing the value of the "EnableGatewayKeyCache" tag in that cluster.  Leave everything else in the APIGateway section alone.  We will actually revisit that section when we configure the publisher and store nodes.<br />Because the gateway isn't responsible for some things, such as key security, you can comment out the sections titled <authmanager> and <database>.</database></authmanager><br />The final tweak in this file is to set the SignatureAlgorithim:<br /><pre class="xml" name="code">    ...<br />    &lt;SignatureAlgorithm&gt;SHA256withRSA&lt;/SignatureAlgorithm&gt;<br />    ...<br /></pre>In my experience the value is already SHA256withRSA but it is commented out; so just uncomment it.<br /><h5>Performance Tuning</h5>At this point the gateway node is setup to act as a gateway but the WSO2 folks also have some production recommendations to improve performance.  These are similar to, if not identical to, the suggestions made earlier for the keymanager.  First off we edit the {GATEWAY_CONF}/axis2/axis2_client.xml file:<br /><pre class="xml" name="code">    ...<br />    &lt;parameter name="defaultMaxConnPerHost"&gt;1000&lt;/parameter&gt;<br />    &lt;!-- commons-http-client maxTotalConnections --&gt;<br />    &lt;parameter name="maxTotalConnections"&gt;30000&lt;/parameter&gt;<br />    ...<br /></pre>Next, we need to edit the {GATEWAY_CONF}/tomcat/catalina-server.xml:<br /><pre class="xml" name="code">    maxThreads="750"<br />    minSpareThreads="150"<br />    maxKeepAliveRequests="600"<br />    acceptCount="600"<br /></pre>You may notice that we didn't modify some of the same values we tweaked for the keymanager; that's okay - they serve different roles. Finally, we need to edit the {GATEWAY_CONF}/nhttp.properties file. <br /><pre class="xml" name="code">    http.socket.timeout=60000<br />    #http.socket.buffer-size=8192<br />    #http.tcp.nodelay=1<br />    #http.connection.stalecheck=0<br /><br />    # Uncomment the following property for an AIX based deployment<br />    #http.nio.interest-ops-queueing=true<br /><br />    # HTTP Sender thread pool parameters<br />    snd_t_core=200<br />    snd_t_max=250<br />    #snd_alive_sec=5<br />    #snd_qlen=-1<br />    snd_io_threads=16<br /><br />    # HTTP Listener thread pool parameters<br />    lst_t_core=200<br />    lst_t_max=250<br />    #lst_alive_sec=5<br />    #lst_qlen=-1<br />    lst_io_threads=16<br /></pre>I've include the contents of my entire nhttp.properties file showing what is commented out as well (comments are prefixed with a #).<br />The gateway is now configured.  Feel free to start it up to make sure there are no syntax errors and so that it is ready for the store and publisher nodes we are about to put together:<br /><pre class="sql" name="code">$ cd {GATEWAY_HOME}/bin<br />$ ./wso2server.sh<br /></pre>NOTE: we didn't use the -Dsetup switch when starting this time.  Remember, after you've done it once you don't want to do it again as it will reinitialize your database.   Thus the next time you start the keymanager you shouldn't use that switch either.<br /><h3>The Publisher</h3>Setting up the publisher is pretty easy.  It's just a matter of telling that node where the keymanager and gateway are within the api-manager.xml file.  I'll call {PUB_HOME}/repository/conf {PUB_CONF} so go to {PUB_CONF}/api-manager.xml and make the following changes:<br /><pre class="xml" name="code">    &lt;AuthManager&gt;<br />        &lt;ServerURL&gt;https://{KEYMANAGER_IP}:9484/services/&lt;/ServerURL&gt;<br />        &lt;Username&gt;admin&lt;/Username&gt;<br />        &lt;Password&gt;admin&lt;/Password&gt;<br />    &lt;/AuthManager&gt;<br /></pre>The keymanager is actually serving two roles in the overall installation.  The first role is to provide login authentication to the various Carbon applications (including the Jaggery based front-end for the publisher and store).  The second is to generate and validate API keys; which is initiated within the store. This change tells the publisher to log people in via the keymanager.  Next we tell the publisher about the Gateway:<br /><pre class="xml" name="code">    &lt;APIGateway&gt;<br />        &lt;ServerURL&gt;https://{GATEWAY_IP}:9485/services/&lt;/ServerURL&gt;<br />        &lt;Username&gt;admin&lt;/Username&gt;<br />        &lt;Password&gt;admin&lt;/Password&gt;<br />        &lt;APIEndpointURL&gt;http://${carbon.local.ip}:${http.nio.port},https://${carbon.local.ip}:${https.nio.port}&lt;/APIEndpointURL&gt;<br />        &lt;EnableGatewayKeyCache&gt;false&lt;/EnableGatewayKeyCache&gt;<br />    &lt;/APIGateway&gt;<br /></pre>The publisher really only cares about the ServerURL, Username, and Password values.  Basically, after you create an API in the publisher you can change the API status from CREATED to PUBLISHED or <span style="font-family: inherit;">BLOCKED </span>(or a couple other values).  When you make these "lifecycle" changes you can have the publisher push the change information to the gateway.  Remember, the port associated with the {GATEWAY_IP}, 9485, is based on an offset of 42 and can be found in the gateway terminal like so:<br /><pre>[2012-11-29 09:01:42,295]  INFO - CarbonUIServiceComponent Mgt Console URL  : https://{GATEWAY_IP}:9485/carbon/<br /></pre><pre><span style="font-family: inherit;"><br /></span></pre><pre></pre>Next up, comment out the APIKeyManager section. The publisher doesn't this part at all. &nbsp;At a minimum set <b><span style="font-family: Courier New, Courier, monospace;">EnableThirftServer </span></b>to false. &nbsp;If you don't it will conflict with the keyserver and you'll have problems.<br /><br />There is just one more thing we have to do - change the Port Offset! Don't forget this step!.  Jump into the {PUB_CONF}/carbon.xml file and change it:<br /><pre class="xml" name="code">        ...<br />    &lt;Ports&gt;<br /><br />        &lt;!-- Ports offset. This entry will set the value of the ports defined below to<br />         the define value + Offset.<br />         e.g. Offset=2 and HTTPS port=9443 will set the effective HTTPS port to 9445<br />         --&gt;<br />        &lt;Offset&gt;43&lt;/Offset&gt;<br />        ...<br /></pre>Optionally, can remove the store jaggery app so that any attempts to access this node as a store will redirect to the carbon management console. To do this you would go to the {PUBLISHER_HOME}/repository/deployment/server/jaggeryapps and delete the store directory:<br /><pre class="xml" name="code">$ cd {PUBLISHER_HOME}/repository/deployment/server/jaggeryapps<br />$ rm -Rf store<br /></pre>Now you're ready to start the publisher:<br /><pre class="sql" name="code">$ cd {PUBLISHER_HOME}/bin<br />$ ./wso2server.sh<br /></pre><h3>The Store</h3>We have reached the final node for configuration.  Let's start by setting the Port Offset in {STORE_CONF}/carbon.xml:<br /><pre class="xml" name="code">        ...<br />    &lt;Ports&gt;<br /><br />        &lt;!-- Ports offset. This entry will set the value of the ports defined below to<br />         the define value + Offset.<br />         e.g. Offset=2 and HTTPS port=9443 will set the effective HTTPS port to 9445<br />         --&gt;<br />        &lt;Offset&gt;44&lt;/Offset&gt;<br />        ...<br /></pre>The only other file we need to edit for the store is the api-manager.xml file at {STORE_CONF}/api-manager.xml.  First we need to tell the store where the keymanager is for the purpose of logging in:<br /><pre class="xml" name="code">    &lt;AuthManager&gt;<br />        &lt;ServerURL&gt;https://{KEYMANAGER_IP_ADDRESS}:9484/services/&lt;/ServerURL&gt;<br />        &lt;Username&gt;admin&lt;/Username&gt;<br />        &lt;Password&gt;admin&lt;/Password&gt;<br />    &lt;/AuthManager&gt;<br /></pre>Next we need to identify the keymanager again but this time for the purposes of generating API keys:<br /><pre class="xml" name="code">    &lt;APIKeyManager&gt;<br />        &lt;ServerURL&gt;https://{KEYMANAGER_IP_ADDRESS}:9484/services/&lt;/ServerURL&gt;<br />        &lt;Username&gt;admin&lt;/Username&gt;<br />        &lt;Password&gt;admin&lt;/Password&gt;<br />        &lt;EnableJWTCache&gt;false&lt;/EnableJWTCache&gt;<br />        &lt;EnableKeyMgtValidationInfoCache&gt;false&lt;/EnableKeyMgtValidationInfoCache&gt;<br />        &lt;KeyValidatorClientType&gt;ThriftClient&lt;/KeyValidatorClientType&gt;<br />        &lt;ThriftClientPort&gt;10397&lt;/ThriftClientPort&gt;<br />        &lt;ThriftClientConnectionTimeOut&gt;10000&lt;/ThriftClientConnectionTimeOut&gt;<br />        &lt;ThriftServerPort&gt;10398&lt;/ThriftServerPort&gt;<br />        &lt;EnableThriftServer&gt;false&lt;/EnableThriftServer&gt;<br />       &lt;!-- &lt;RemoveUserNameToJWTForApplicationToken&gt;true&lt;/RemoveUserNameToJWTForApplicationToken&gt;--&gt;<br />    &lt;/APIKeyManager&gt;<br /></pre>NOTE: you MUST turn off the ThriftServer by setting the &lt;EnableThriftServer&gt; value to false.<br />The final configuration step is to tell the store where the gateway is - that is done like so:<br /><pre class="xml" name="code">    &lt;APIGateway&gt;<br />        &lt;ServerURL&gt;https://{GATEWAY_IP_ADDRESS}:9485/services/&lt;/ServerURL&gt;<br />        &lt;Username&gt;admin&lt;/Username&gt;<br />        &lt;Password&gt;admin&lt;/Password&gt;<br />        &lt;APIEndpointURL&gt;http://{GATEWAY_IP_ADDRESS}:8322,https://{GATEWAY_IP_ADDRESS}:8285&lt;/APIEndpointURL&gt;<br />        &lt;EnableGatewayKeyCache&gt;false&lt;/EnableGatewayKeyCache&gt;<br />    &lt;/APIGateway&gt;<br /></pre>When doing this you might notice I changed the APIEndpointURL as well to point to the gateway as well as some different looking port numbers.  When the gateway starts up there are a couple of log messages that look like this: <br /><pre>[2012-11-29 09:01:39,063]  INFO - HttpCoreNIOListener HTTPS Listener started on port : 8285<br />[2012-11-29 09:01:39,115]  INFO - HttpCoreNIOListener HTTP Listener started on port : 8322<br /></pre>These tell us what ports the gateways is listening on for API requests.  Basically, any app that uses the API will end up calling the gateways IP at the appropriate port (based on HTTP or HTTPS needs) along with some form of API path in the url to identify the API being called.  If you had a load balancer in front of a bunch of gateway nodes you'd set the APIEndPointURL value to your load balancer's IP address and use the ports you've mapped in your load-balancer that point to the correct protocol (http or https).<br />At this point you've finished the required configuration for your store. You can optionally remove the publisher jaggery app so that people don't try to access the publisher on your store node.:<br /><pre class="xml" name="code">$ cd {STORE_HOME}/repository/deployment/server/jaggeryapps<br />$ rm -Rf publisher<br /></pre>Now you're ready to start the store!<br /><pre class="sql" name="code">$ cd {STORE_HOME}/bin<br />$ ./wso2server.sh<br /></pre>If you made it this far then congratulations.  You should now have four APM nodes running; a gateway, a keymanager, a publisher, and a store.  All of which are being governed by a Remote Governance Registry (GREG).  While none of these changes were hard to make there were a lot of them to make and thus plenty of opportunities to miss something.  If one of your nodes isn't working check the Port Offset and then check each of the xml files you edited to make sure there are no syntax errors.<br /><br />NOTE: If, after trying to load the store in your browser, you see a bunch of errors in the corresponding terminal relating to executing queries against the remote governance registry try the following steps to fix them:<br /><br /><ol><li>Make sure the GREG has the same instance ID in all of your nodes and that no other installation of the WSO2 components has the same GREG instance ID name.</li><li>comment out the GREG parts of the {STORE_HOME}/repository/conf/registry.xml file; then start the store with the -Dsetup option. &nbsp;Then stop the store, uncomment the GREG section of the registry.xml and then restart the store without the -Dsetup option</li></ol><div><br /></div><br /><br /><br /><br /></div>
