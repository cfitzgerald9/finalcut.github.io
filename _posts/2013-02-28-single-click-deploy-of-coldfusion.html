---
layout: post
title: "Single Click Deploy of a Coldfusion Project from ANT"
date: 2013-02-28
comments: false
categories:
 - svnant
 - one-click-deploy
 - ant-zip
 - ant-subversion
 - ant-email
 - ant
---

<div class='post'>
Sometimes I'm way behind the power curve. &nbsp;Today is one of those days. &nbsp;I've been using ant and cruise control for years to do some continuous integration testing of some ColdFusion projects but until today I didn't have any where there was a single click deploy process.<br /><br />The project I set it up on is being managed in subversion - so if you use Git or some other version control system you'll have to adapt this to suit your own needs.<br /><br />Before I start sharing the ant scripts here is some important background information you need to know and understand in order to actually make sense of the ant stuff. &nbsp;First up is our branching and tagging policy for the project.<br /><br />We use trunk as the main development branch. &nbsp;We don't do big feature development on it but any quick bug fixes or what-not end up happening on trunk. &nbsp;We also have a UAT and a PRODUCTION branch. &nbsp;New features that our customer wants to test before delivery get merged from trunk to the UAT branch. &nbsp;New features are developed on feature branches but once they are ready for UAT they get merged into TRUNK and then merged into UAT. &nbsp;Once the feature is finished in the feature branch and we are making simple bug fixes to the features we typically make those just in TRUNK and merge to UAT.<br /><br />We don't merge into production until things have cleared UAT. &nbsp;Once we are ready to merge into UAT we make one final edit - to a file in the root of the projects directory called application.version.tag.cfm - this file just contains the new version number for the application. &nbsp;This version number will also be used to create a release tag in subversion as part of the deployment process. &nbsp;Once that version file is updated and commited we then merge all of the relevant changes from trunk to production for that release. &nbsp;It is really important to have good comments and, ideally, issue numbers related to each commit for that feature set that is about to be pushed to production.<br /><br />Once the merge into production is done and we are confident we want to push the changes to production we go to our continuous integration server (we recently moved from cruisecontrol to jenkins) and fire off the production job for that project.<br /><br />The production job does the following things:<br /><ol><li>updates the local production test webserver with the latest version of the production branch</li><li>runs our suite of tests against the production test webserver</li><li>if the tests pass...</li><li>reads in the contents of application.version.tag.cfm to get the version number</li><li>checks to see if a tag in subversion already exists for that version number</li><li>if the tag exists the build stops and the user is prompted to either update the version number or manually delete the tag from subversion.</li><li>if the tag doesn't exist...&nbsp;</li><li>create a tag in subversion based on the production branch named the same as the version number</li><li>export the newly created tag to a staging directory</li><li>delete any subdirectories or files we manage in subversion but which we don't deploy to production</li><li>create a zip file of the remaining tag export files/directories</li><li>delete the exported files that remain but keep the zip handy</li><li>copy the zip file to a place where the customer can get it*</li><li>delete the zip file from the staging location</li><li>send out an email to the customer (and us) letting folks know the production zip file is ready.</li></ol><div>The purists among you may say - wait this isn't a one click deploy - production isn't actually updated by this. And to you I say, "I know. &nbsp;It sucks but I must work within the limitations I have"<br /><br />The customer only lets us connect to them via special laptops they provide and only when those machines are connected to their vpn using a timed key token. &nbsp;There just isn't a practical way to connect to them, then map to their webserver, and then copy the files over the network to them within those constraints. &nbsp; Thus we get as close to copying the files to the webserver as we can.</div><div><br /></div><div>I'm not going to explain every property that these ant tasks use. &nbsp;You'll just have to figure them out on your own sorry but hopefully they are fairly obvious. &nbsp;I'm also not showing the task that runs the tests or the one that updates our production test webserver in order to run the tests.</div><div><br /></div><div>This task gets the party started:</div><div><br /></div><div><br /></div><pre class="xml" name="code"> &lt;target name="releaseIfNoProblems"&gt;<br />  &lt;if&gt;<br />   &lt;equals arg1="${mxunit.error}" arg2="false" /&gt;<br />    &lt;then&gt;<br />     &lt;if&gt;<br />      &lt;equals arg1="${mxunit.fail}" arg2="false" /&gt;<br />      &lt;then&gt;<br />       &lt;antcall target="createTagInSvn" /&gt;<br />       &lt;antcall target="package" /&gt;<br />       &lt;antcall target="pushPackagetoPublicWebsite" /&gt;<br />       &lt;antcall target="sendEmailAboutNewRelease" /&gt;<br />      &lt;/then&gt;<br />     &lt;/if&gt;<br />    &lt;/then&gt;<br />  &lt;/if&gt;<br /> &lt;/target&gt;<br /></pre><br />Next up is the set of steps involved with tagging the release in subversion:<br /><br /><pre class="xml" name="code"><br /> &lt;target name="readTagFromFile"&gt;<br />  &lt;loadfile property="svn.tag.name" srcFile="application.version.tag.cfm"/&gt;<br /> &lt;/target&gt;<br /><br /> &lt;target name="createTagInSvn" depends="readTagFromFile"&gt;<br />  &lt;property name="svn.url.tag" value="${svn.url.tags}/${svn.tag.name}" /&gt;<br /><br />  &lt;echo message="source branch: {$svn.url.prod}" /&gt;<br />  &lt;echo message="destionation tag: {$svn.url.tag}" /&gt;<br /><br /><br /><br />   &lt;condition property="svn.tag.exists" value="true" else="false"&gt;<br />          &lt;svnExists javahl="false" svnkit="false" target="${svn.url.tag}" /&gt;<br />      &lt;/condition&gt;<br /><br />  &lt;echo message="svn tag exists: ${svn.tag.exists}" /&gt;<br />  &lt;if&gt;<br />   &lt;equals arg1="${svn.tag.exists}" arg2="true" /&gt;<br />    &lt;then&gt;<br />     &lt;!--<br />      IF we wanted to delete the tag, just in case, before proceeding we could make this block active...<br />     --&gt;<br />     &lt;svn username="${svn.username}" password="${svn.password}" javahl="false" svnkit="false" failonerror="false"&gt;<br />      &lt;delete url="${svn.url.tag}" message=" [Build Script] delete previous tag: ${svn.tag.name}" /&gt;<br />     &lt;/svn&gt;<br />     &lt;fail message="The tag ${svn.tag.name} already exists in Subversion.  Please update the application.version.tag.cfm file OR delete the tag in subversion" /&gt;<br />    &lt;/then&gt;<br />    &lt;elseif&gt;<br />     &lt;equals arg1="${svn.tag.exists}" arg2="false" /&gt;<br />     &lt;then&gt;<br />      &lt;echo message="the tag doesn't exist yet so let's proceed..." /&gt;<br /><br />      &lt;svn username="${svn.username}" password="${svn.password}" javahl="false" svnkit="false" failonerror="true"&gt;<br />       &lt;copy srcurl="${svn.url.prod}" desturl="${svn.url.tag}" message=" [Build Script] created tag: ${svn.tag.name}" /&gt;<br />      &lt;/svn&gt;<br />     &lt;/then&gt;<br />    &lt;/elseif&gt;<br />  &lt;/if&gt;<br />  &lt;echo message=" ... tagging completed." /&gt;<br /> &lt;/target&gt;<br /></pre><br />Here is the packaging process: <pre name="code" class="xml"><br /> &lt;target name="prepPackagingArea"&gt;<br />   &lt;delete dir="${package.dir}${ant.project.name}/" /&gt;<br />   &lt;delete file="${package.dir}${package.name}" /&gt;<br /> &lt;/target&gt;<br /><br /> &lt;target name="cleanupPackaging"&gt;<br />   &lt;delete dir="${package.dir}${ant.project.name}/" /&gt;<br /> &lt;/target&gt;<br /><br /> &lt;target name="zipPackage" depends="delDirFromPackage"&gt;<br />  &lt;zip destfile="${package.dir}${package.name}" basedir="${package.checkdir}" /&gt;<br /> &lt;/target&gt;<br /><br /> &lt;target name="delDirFromPackage"&gt;<br />  &lt;delete dir="${package.checkdir}_Database/" /&gt;<br />  &lt;delete dir="${package.checkdir}_DetailImport/" /&gt;<br />  &lt;delete dir="${package.checkdir}_Documentation/" /&gt;<br />  &lt;delete dir="${package.checkdir}uitests/" /&gt;<br />  &lt;delete dir="${package.checkdir}testresults/" /&gt;<br />  &lt;delete dir="${package.checkdir}MVInstall/" /&gt;<br />  &lt;delete dir="${package.checkdir}Replication/" /&gt;<br />  &lt;delete dir="${package.checkdir}styles/" /&gt;<br />  &lt;delete dir="${package.checkdir}unittests/" /&gt;<br />  &lt;delete dir="${package.checkdir}Updater/" /&gt;<br />  &lt;delete&gt;<br />   &lt;fileset dir="${package.checkdir}" includes="*.xml*" /&gt;<br />   &lt;fileset dir="${package.checkdir}" includes="*.bat" /&gt;<br />   &lt;fileset dir="${package.checkdir}" includes="application.lines.cfm" /&gt;<br />   &lt;fileset dir="${package.checkdir}Config/" includes="config.*" /&gt;<br />  &lt;/delete&gt;<br /> &lt;/target&gt;<br /><br /> &lt;target name="package" depends="prepPackagingArea, readTagFromFile"&gt;<br />  &lt;svn username="${svn.username}" password="${svn.password}" javahl="false" svnkit="false" failonerror="false"&gt;<br />    &lt;export srcurl="${svn.url.tags}/${svn.tag.name}" revision="HEAD" destPath="${package.checkdir}" /&gt;<br />  &lt;/svn&gt;<br />  &lt;antcall target="zipPackage" /&gt;<br /><br />  &lt;antcall target="cleanupPackaging" /&gt;<br /> &lt;/target&gt;<br /></pre><br />Then we need to push the package to the deployment directory and delete the zip file from staging: <br /><pre name="code" class="xml"><br /> &lt;target name="pushPackagetoPublicWebsite"&gt;<br />  &lt;echo message="pushing the package to an accessible location ${deploy.dir}\${package.name}"/&gt;<br /><br />  &lt;copy file="${package.dir}${package.name}" tofile="${deploy.dir}\${package.name}" overwrite="true" force="true" /&gt;<br /><br />  &lt;delete dir="${package.dir}" /&gt;<br /> &lt;/target&gt;<br /></pre><br />Finally I need to send out the email(s): <pre name="code" class="xml"><br /> &lt;target name="sendEmailAboutNewRelease" depends="readTagFromFile"&gt;<br />  &lt;echo message="sending email"/&gt;<br />  &lt;mail from="XXX" tolist="XXX" mailhost="SOMEHOST" message="Please go to ... and download the zip file for deployment.  Remember, this doesn't include the production config.xml file so you need to preserve the config file at ${ant.project.name}\config\config.xml" subject="${ant.project.name} has a new release ready for installation: version ${svn.tag.name}" /&gt;<br /> &lt;/target&gt;<br /></pre> As you might imagine I had to add some extra libraries to ANT.  First was the svnant library and then I also had to add ant contrib and finally two jar files from oracle in order to get the mail stuff to work <a href="http://www.oracle.com/technetwork/java/index-138643.html">mail.jar</a> and <a href="http://www.oracle.com/technetwork/java/javase/downloads/index-135046.html">activation.jar</a></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Jim Priest</div>
<div class='content'>
Added to the old Ant wiki:  http://www.thecrumb.com/wiki/ant</div>
</div>
</div>
